<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Contractor Dashboard — Carlisle</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    body{font-family:Inter, system-ui, -apple-system, Arial, sans-serif;background:#f3f7f6;margin:0}
    .topbar{display:flex;align-items:center;justify-content:space-between;padding:18px 28px;background:#0f2430;color:white}
    .brand{display:flex;align-items:center;gap:12px}
    .container{max-width:1100px;margin:28px auto;padding:0 18px}
    .grid{display:grid;grid-template-columns:1fr 320px;gap:20px}
    .card{background:white;padding:18px;border-radius:10px;box-shadow:0 6px 18px rgba(20,20,20,0.06)}
    h2{margin:0 0 8px}
    .projects li{margin:10px 0;padding:10px;border-radius:8px;border:1px solid #eef7f6;list-style:none}
    .actions{display:flex;gap:8px;margin-top:12px}
    .btn{padding:10px 12px;border-radius:8px;border:none;background:#c62828;color:white;cursor:pointer}
    .doc-btn{padding:8px 10px;border-radius:6px;border:none;background:#0b84a5;color:white;cursor:pointer;font-size:13px}
    .secondary{background:#eef7f6;color:#0f2430}
    .muted{color:#6b6b6b}
    .meta{font-size:13px;color:#586a6b}
    .doc-card:hover{box-shadow:0 4px 12px rgba(0,0,0,0.1);transform:translateY(-1px)}
    @media(max-width:880px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="topbar">
    <div class="brand">
      <div style="width:44px;height:44px;border-radius:8px;background:#c62828;display:flex;align-items:center;justify-content:center;font-weight:700">C</div>
      <div>
        <div style="font-weight:700">Carlisle</div>
        <div style="font-size:12px;opacity:0.9">Contractor Dashboard</div>
      </div>
    </div>
    <div style="display:flex;align-items:center;gap:12px">
      <select id="userRole" style="padding:8px 10px;border-radius:8px;border:none"></select>
      <div id="userInfo" class="meta"></div>
      <button id="signOut" class="btn secondary">Sign Out</button>
    </div>
  </div>

  <main class="container dashboard">
    <div style="display:flex;gap:18px;align-items:center;flex-wrap:wrap;margin-bottom:18px">
      <div style="flex:1">
        <h2 id="welcomeTitle">Welcome</h2>
        <p id="welcomeDescription" class="muted">Loading...</p>
      </div>
      <div style="display:flex;gap:10px">
        <button onclick="exportDashboardData()" class="btn">Export Data</button>
      </div>
    </div>

    <section id="statsSection" style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:18px">
      <div class="stat-card" style="display:flex;flex-direction:column;align-items:flex-start;padding:12px;background:#1e3a5f;border-radius:8px;cursor:pointer">
        <h3 style="font-size:24px;color:#64b5f6;margin:0">—</h3>
        <p class="muted" style="color:#b0c4de;margin:0">Stat</p>
      </div>
      <div class="stat-card" style="display:flex;flex-direction:column;align-items:flex-start;padding:12px;background:#1e3a5f;border-radius:8px;cursor:pointer">
        <h3 style="font-size:24px;color:#64b5f6;margin:0">—</h3>
        <p class="muted" style="color:#b0c4de;margin:0">Stat</p>
      </div>
      <div class="stat-card" style="display:flex;flex-direction:column;align-items:flex-start;padding:12px;background:#1e3a5f;border-radius:8px;cursor:pointer">
        <h3 style="font-size:24px;color:#64b5f6;margin:0">—</h3>
        <p class="muted" style="color:#b0c4de;margin:0">Stat</p>
      </div>
    </section>

    <div class="grid">
      <section>
        <div style="padding:18px;border-radius:10px;box-shadow:0 6px 18px rgba(20,20,20,0.06);background:#1e3a5f">
          <h3 style="color:#e8f0f7">Features</h3>
          <p class="muted" style="color:#b0c4de">Tools available to you</p>
          <div id="featuresGrid" style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:12px"></div>
        </div>

        <div id="activitySection" style="margin-top:16px;padding:18px;border-radius:10px;box-shadow:0 6px 18px rgba(20,20,20,0.06);background:#1e3a5f">
          <h3 style="color:#e8f0f7">Recent Activity</h3>
          <div id="activityList" style="margin-top:10px"></div>
        </div>
      </section>

      <aside>
        <!-- Permissions panel intentionally removed -->
      </aside>
    </div>

    <!-- Detail Modal for Stat Card Drill-Down -->
    <div id="detailModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);z-index:1000;padding:20px">
      <div style="background:white;border-radius:10px;max-width:800px;margin:50px auto;padding:30px;max-height:80vh;overflow-y:auto">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px">
          <h2 id="detailTitle" style="color:black;margin:0">Details</h2>
          <button onclick="closeDetailModal()" style="background:none;border:none;font-size:24px;cursor:pointer">&times;</button>
        </div>
        <div id="detailContent" style="color:#333">
          <!-- Content populated by JavaScript -->
        </div>
      </div>
    </div>
  </main>

    <!-- Documents Modal for Job-specific files/photos -->
    <div id="docModal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.6);z-index:1100;padding:20px">
      <div style="background:white;border-radius:10px;max-width:900px;margin:50px auto;padding:24px;max-height:80vh;overflow-y:auto">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
          <h2 id="docModalTitle" style="color:black;margin:0">Documents</h2>
          <button onclick="closeDocModal()" style="background:none;border:none;font-size:24px;cursor:pointer">&times;</button>
        </div>
        <div id="docModalContent" style="color:#333">
          <!-- Populated by openJobDocuments(jobId) -->
        </div>
      </div>
    </div>

  <!-- Load roleConfig and main app logic, then finish session wiring -->
  <script src="roleConfig.js"></script>

  <script>
    // Populate role selector from roleConfig (so app.js can attach handlers)
    (function populateRoles(){
      const roleDropdown = document.getElementById('userRole');
      if(!window.roleConfig) return;
      Object.keys(roleConfig).forEach(rk=>{
        const opt = document.createElement('option');
        opt.value = rk; opt.textContent = roleConfig[rk].name || rk;
        roleDropdown.appendChild(opt);
      });
    })();
  </script>

  <script src="app.js"></script>
 
  <script>
    // After app.js initializes, wire session and set role
    (function finishInit(){
      const session = sessionStorage.getItem('demoUser');
      if(!session){
        location.href = 'index.html';
        return;
      }
      const user = JSON.parse(session || '{}');

      // map role label (from index.html) like 'Contractor' to roleConfig key 'contractor'
      function normalize(roleLabel){
        return (roleLabel || '').toString().toLowerCase().replace(/\s+/g,'-');
      }

      const roleKey = normalize(user.role) || 'contractor';
      const roleDropdown = document.getElementById('userRole');
      if(roleDropdown){
        if(Array.from(roleDropdown.options).some(o=>o.value===roleKey)){
          roleDropdown.value = roleKey;
        }
      }

      // Display user info
      const userInfo = document.getElementById('userInfo');
      if(userInfo) userInfo.textContent = (user.name || user.email || '') + ' • ' + (user.role || '');

      // Ask app.js to render dashboard for this role
      if(typeof updateDashboard === 'function'){
        updateDashboard(roleKey);
      }

      // Sign out
      document.getElementById('signOut').addEventListener('click', ()=>{
        sessionStorage.removeItem('demoUser');
        location.href = 'index.html';
      });

      // Make stat cards clickable for drill-down
      attachStatCardListeners();
    })();
  </script>

  <script>
    // Sample data for drill-down detail views
    const detailData = {
      activeJobs: [
          { id: '2024-0156', name: 'Commercial Building Reroof', status: 'In Progress', date: '2024-02-05', documents: [
            { type: 'Product Document', name: 'TPO Spec Sheet.pdf', url: 'docs/2024-0156-spec.pdf', size: '2.3 MB', uploadedBy: 'John Smith', uploadedAt: '2024-01-12' },
            { type: 'Product Document', name: 'Installation Guide.pdf', url: 'docs/2024-0156-install.pdf', size: '4.1 MB', uploadedBy: 'Carlisle Support', uploadedAt: '2024-01-10' },
            { type: 'Photo', name: 'Site-Before.jpg', url: 'https://via.placeholder.com/800x480?text=Before+2024-0156', size: '1.8 MB', uploadedBy: 'Foreman', uploadedAt: '2024-01-14' },
            { type: 'Photo', name: 'Site-Progress-01.jpg', url: 'https://via.placeholder.com/800x480?text=Progress+2024-0156', size: '2.1 MB', uploadedBy: 'Crew Lead', uploadedAt: '2024-02-01' },
            { type: 'Photo', name: 'Site-Progress-02.jpg', url: 'https://via.placeholder.com/800x480?text=Progress+2+2024-0156', size: '1.9 MB', uploadedBy: 'Crew Lead', uploadedAt: '2024-02-03' }
          ] },
          { id: '2024-0155', name: 'Residential Roof Replacement', status: 'In Progress', date: '2024-02-04', documents: [
            { type: 'Product Document', name: 'Shingle Data Sheet.pdf', url: 'docs/2024-0155-shingle.pdf', size: '1.5 MB', uploadedBy: 'Sarah Johnson', uploadedAt: '2024-01-20' },
            { type: 'Warranty Document', name: 'Manufacturer Warranty.pdf', url: 'docs/2024-0155-warranty.pdf', size: '680 KB', uploadedBy: 'Admin', uploadedAt: '2024-01-22' },
            { type: 'Photo', name: 'Before-Front.jpg', url: 'https://via.placeholder.com/800x480?text=Front+2024-0155', size: '2.4 MB', uploadedBy: 'Foreman', uploadedAt: '2024-01-25' },
            { type: 'Photo', name: 'Before-Rear.jpg', url: 'https://via.placeholder.com/800x480?text=Rear+2024-0155', size: '2.2 MB', uploadedBy: 'Foreman', uploadedAt: '2024-01-25' }
          ] },
          { id: '2024-0154', name: 'Industrial Facility Roofing', status: 'In Progress', date: '2024-02-03', documents: [
            { type: 'Product Document', name: 'EPDM Membrane Spec.pdf', url: 'docs/2024-0154-membrane.pdf', size: '3.1 MB', uploadedBy: 'John Smith', uploadedAt: '2024-01-18' },
            { type: 'Product Document', name: 'Safety Data Sheet.pdf', url: 'docs/2024-0154-sds.pdf', size: '420 KB', uploadedBy: 'Carlisle Support', uploadedAt: '2024-01-18' },
            { type: 'Photo', name: 'Aerial-Overview.jpg', url: 'https://via.placeholder.com/800x480?text=Aerial+2024-0154', size: '3.5 MB', uploadedBy: 'Drone Operator', uploadedAt: '2024-01-20' },
            { type: 'Inspection Report', name: 'Pre-Install Inspection.pdf', url: 'docs/2024-0154-inspection.pdf', size: '1.2 MB', uploadedBy: 'Mike Williams', uploadedAt: '2024-01-19' }
          ] },
          { id: '2024-0153', name: 'Mall Roof Repair', status: 'Pending', date: '2024-02-02', documents: [
            { type: 'Product Document', name: 'Repair Plan.pdf', url: 'docs/2024-0153-plan.pdf', size: '890 KB', uploadedBy: 'John Smith', uploadedAt: '2024-01-28' },
            { type: 'Product Document', name: 'Material List.pdf', url: 'docs/2024-0153-materials.pdf', size: '320 KB', uploadedBy: 'Estimator', uploadedAt: '2024-01-29' }
          ] },
          { id: '2024-0152', name: 'Office Complex Reroof', status: 'Pending', date: '2024-02-01', documents: [
            { type: 'Photo', name: 'Access-Point.jpg', url: 'https://via.placeholder.com/800x480?text=Access+2024-0152', size: '1.6 MB', uploadedBy: 'Site Manager', uploadedAt: '2024-01-30' },
            { type: 'Photo', name: 'Current-Condition.jpg', url: 'https://via.placeholder.com/800x480?text=Condition+2024-0152', size: '2.0 MB', uploadedBy: 'Site Manager', uploadedAt: '2024-01-30' },
            { type: 'Product Document', name: 'Scope of Work.pdf', url: 'docs/2024-0152-scope.pdf', size: '1.1 MB', uploadedBy: 'John Smith', uploadedAt: '2024-01-28' }
          ] },
          { id: '2024-0151', name: 'Warehouse Roof Maintenance', status: 'Pending', date: '2024-01-31', documents: [
            { type: 'Product Document', name: 'Maintenance Checklist.pdf', url: 'docs/2024-0151-checklist.pdf', size: '540 KB', uploadedBy: 'Admin', uploadedAt: '2024-01-25' }
          ] },
          { id: '2024-0150', name: 'High-Rise Building Inspection', status: 'Planning', date: '2024-01-30', documents: [
            { type: 'Product Document', name: 'Inspection Criteria.pdf', url: 'docs/2024-0150-criteria.pdf', size: '780 KB', uploadedBy: 'Inspector', uploadedAt: '2024-01-22' },
            { type: 'Product Document', name: 'Building Specs.pdf', url: 'docs/2024-0150-building.pdf', size: '5.2 MB', uploadedBy: 'Property Manager', uploadedAt: '2024-01-20' }
          ] },
          { id: '2024-0149', name: 'School Roof Assessment', status: 'Planning', date: '2024-01-29', documents: [
            { type: 'Photo', name: 'North-Wing.jpg', url: 'https://via.placeholder.com/800x480?text=North+Wing+2024-0149', size: '2.8 MB', uploadedBy: 'Site Surveyor', uploadedAt: '2024-01-20' },
            { type: 'Photo', name: 'South-Wing.jpg', url: 'https://via.placeholder.com/800x480?text=South+Wing+2024-0149', size: '2.6 MB', uploadedBy: 'Site Surveyor', uploadedAt: '2024-01-20' }
          ] },
          { id: '2024-0148', name: 'Healthcare Facility Roofing', status: 'Planning', date: '2024-01-28', documents: [
            { type: 'Product Document', name: 'Material Datasheet.pdf', url: 'docs/2024-0148-datasheet.pdf', size: '1.8 MB', uploadedBy: 'Carlisle Support', uploadedAt: '2024-01-15' },
            { type: 'Warranty Document', name: 'Extended Warranty Options.pdf', url: 'docs/2024-0148-warranty.pdf', size: '450 KB', uploadedBy: 'Admin', uploadedAt: '2024-01-16' }
          ] },
          { id: '2024-0147', name: 'Retail Building Repair', status: 'Planning', date: '2024-01-27', documents: [
            { type: 'Photo', name: 'Entrance-Damage.jpg', url: 'https://via.placeholder.com/800x480?text=Entrance+2024-0147', size: '1.9 MB', uploadedBy: 'Foreman', uploadedAt: '2024-01-18' }
          ] },
          { id: '2024-0146', name: 'Government Building Reroof', status: 'Not Started', date: '2024-01-26', documents: [
            { type: 'Product Document', name: 'Bid Documents.pdf', url: 'docs/2024-0146-bid.pdf', size: '3.4 MB', uploadedBy: 'Estimator', uploadedAt: '2024-01-10' },
            { type: 'Product Document', name: 'Compliance Requirements.pdf', url: 'docs/2024-0146-compliance.pdf', size: '1.1 MB', uploadedBy: 'Admin', uploadedAt: '2024-01-12' }
          ] },
          { id: '2024-0145', name: 'Apartment Complex Maintenance', status: 'Not Started', date: '2024-01-25', documents: [
            { type: 'Warranty Document', name: 'Existing Warranty Info.pdf', url: 'docs/2024-0145-warranty.pdf', size: '620 KB', uploadedBy: 'Property Manager', uploadedAt: '2024-01-08' },
            { type: 'Product Document', name: 'Maintenance Schedule.pdf', url: 'docs/2024-0145-schedule.pdf', size: '380 KB', uploadedBy: 'Admin', uploadedAt: '2024-01-09' }
          ] }
      ],
      pendingInspections: [
        { id: 'INS-2024-045', job: 'Commercial Building Reroof', scheduled: '2024-02-15', inspector: 'John Smith' },
        { id: 'INS-2024-044', job: 'Residential Roof Replacement', scheduled: '2024-02-14', inspector: 'Sarah Johnson' },
        { id: 'INS-2024-043', job: 'Industrial Facility Roofing', scheduled: '2024-02-13', inspector: 'Mike Davis' }
      ],
      registeredWarranties: [
        { id: 'WAR-2024-087', product: 'TPO Membrane 60 mil', coverage: '25 Years', registered: '2024-02-08' },
        { id: 'WAR-2024-086', product: 'Metal Standing Seam', coverage: '30 Years', registered: '2024-02-07' },
        { id: 'WAR-2024-085', product: 'Modified Bitumen', coverage: '20 Years', registered: '2024-02-06' },
        { id: 'WAR-2024-084', product: 'Asphalt Shingles', coverage: '25 Years', registered: '2024-02-05' },
        { id: 'WAR-2024-083', product: 'EPDM Membrane', coverage: '20 Years', registered: '2024-02-04' },
        { id: 'WAR-2024-082', product: 'PVC Membrane', coverage: '25 Years', registered: '2024-02-03' },
        { id: 'WAR-2024-081', product: 'Wood Shake', coverage: '30 Years', registered: '2024-02-02' },
        { id: 'WAR-2024-080', product: 'Tile Roofing', coverage: '50 Years', registered: '2024-02-01' },
        { id: 'WAR-2024-079', product: 'TPO Membrane 60 mil', coverage: '25 Years', registered: '2024-01-31' },
        { id: 'WAR-2024-078', product: 'Metal Shingles', coverage: '35 Years', registered: '2024-01-30' },
        { id: 'WAR-2024-077', product: 'Liquid Applied Membrane', coverage: '15 Years', registered: '2024-01-29' },
        { id: 'WAR-2024-076', product: 'Built-Up Roofing', coverage: '20 Years', registered: '2024-01-28' },
        { id: 'WAR-2024-075', product: 'Green/Living Roof', coverage: '25 Years', registered: '2024-01-27' },
        { id: 'WAR-2024-074', product: 'Slate Roofing', coverage: '50+ Years', registered: '2024-01-26' },
        { id: 'WAR-2024-073', product: 'Copper Roofing', coverage: '100+ Years', registered: '2024-01-25' },
        { id: 'WAR-2024-072', product: 'Composite Shingles', coverage: '25 Years', registered: '2024-01-24' },
        { id: 'WAR-2024-071', product: 'TPO Membrane 80 mil', coverage: '25 Years', registered: '2024-01-23' },
        { id: 'WAR-2024-070', product: 'Asphalt Roll Roofing', coverage: '15 Years', registered: '2024-01-22' },
        { id: 'WAR-2024-069', product: 'Metal Roofing Panels', coverage: '40 Years', registered: '2024-01-21' },
        { id: 'WAR-2024-068', product: 'Architectural Shingles', coverage: '25 Years', registered: '2024-01-20' },
        { id: 'WAR-2024-067', product: 'Synthetic Slate', coverage: '30 Years', registered: '2024-01-19' },
        { id: 'WAR-2024-066', product: 'TPO Membrane 45 mil', coverage: '20 Years', registered: '2024-01-18' },
        { id: 'WAR-2024-065', product: 'Premium Asphalt', coverage: '30 Years', registered: '2024-01-17' },
        { id: 'WAR-2024-064', product: 'Standing Seam Metal', coverage: '50 Years', registered: '2024-01-16' },
        { id: 'WAR-2024-063', product: 'Elastomeric Coating', coverage: '10 Years', registered: '2024-01-15' },
        { id: 'WAR-2024-062', product: 'Corrugated Metal', coverage: '30 Years', registered: '2024-01-14' }
      ]
    };

    function openDetailModal(type) {
      const modal = document.getElementById('detailModal');
      const title = document.getElementById('detailTitle');
      const content = document.getElementById('detailContent');
      
      let data, titleText, columns = [];
      
      if (type === 'activeJobs') {
        data = detailData.activeJobs;
        titleText = 'Active Jobs (12)';
        columns = ['ID', 'Name', 'Status', 'Created', 'Docs'];
      } else if (type === 'pendingInspections') {
        data = detailData.pendingInspections;
        titleText = 'Pending Inspections (3)';
        columns = ['ID', 'Job', 'Scheduled', 'Inspector'];
      } else if (type === 'registeredWarranties') {
        data = detailData.registeredWarranties;
        titleText = 'Registered Warranties (28)';
        columns = ['ID', 'Product', 'Coverage', 'Registered'];
      }
      
      title.textContent = titleText;
      
      let html = '<table style="width:100%;border-collapse:collapse;font-size:14px">';
      html += '<tr style="background:#f0f0f0;border-bottom:1px solid #ddd">';
      columns.forEach(col => {
        html += `<th style="padding:10px;text-align:left;font-weight:600;color:#333">${col}</th>`;
      });
      html += '</tr>';
      
      data.forEach((item, idx) => {
        const rowBg = idx % 2 === 0 ? 'background:#fafafa' : '';
        if (type === 'activeJobs') {
          // make entire row clickable to open job documents (also keep View Docs button)
          html += `<tr tabindex="0" role="button" title="Open documents for ${item.id}" onclick="openJobDocuments('${item.id}')" onkeydown="if(event.key==='Enter'){openJobDocuments('${item.id}') }" style="cursor:pointer;border-bottom:1px solid #eee;${rowBg}">`;
          html += `<td style="padding:10px">${item.id}</td>`;
          html += `<td style="padding:10px">${item.name}</td>`;
          // color-code status badges
          (function(){
            const s = (item.status || '').toString();
            let statusHtml = '<span style="background:#f3f4f6;color:#374151;padding:4px 8px;border-radius:4px">' + s + '</span>';
            if (/in progress/i.test(s)) {
              statusHtml = '<span style="background:#e6f7ff;color:#0369a1;padding:4px 8px;border-radius:4px">' + s + '</span>';
            } else if (/pending/i.test(s)) {
              statusHtml = '<span style="background:#fff7ed;color:#92400e;padding:4px 8px;border-radius:4px">' + s + '</span>';
            } else if (/planning/i.test(s)) {
              statusHtml = '<span style="background:#f8fafc;color:#6b7280;padding:4px 8px;border-radius:4px">' + s + '</span>';
            } else if (/not started/i.test(s)) {
              statusHtml = '<span style="background:#f8fafc;color:#6b7280;padding:4px 8px;border-radius:4px">' + s + '</span>';
            } else if (/complete|completed|done/i.test(s)) {
              statusHtml = '<span style="background:#e6ffed;color:#047857;padding:4px 8px;border-radius:4px">' + s + '</span>';
            }
            html += '<td style="padding:10px">' + statusHtml + '</td>';
          })();
          html += `<td style="padding:10px">${item.date}</td>`;
          html += `<td style="padding:10px"><button class="doc-btn" onclick="event.stopPropagation(); openJobDocuments('${item.id}')">View Docs</button></td>`;
        } else {
          html += `<tr style="border-bottom:1px solid #eee;${rowBg}">`;
          if (type === 'pendingInspections') {
            html += `<td style="padding:10px">${item.id}</td>`;
            html += `<td style="padding:10px">${item.job}</td>`;
            html += `<td style="padding:10px">${item.scheduled}</td>`;
            html += `<td style="padding:10px">${item.inspector}</td>`;
          } else if (type === 'registeredWarranties') {
            html += `<td style="padding:10px">${item.id}</td>`;
            html += `<td style="padding:10px">${item.product}</td>`;
            html += `<td style="padding:10px">${item.coverage}</td>`;
            html += `<td style="padding:10px">${item.registered}</td>`;
          }
        }
        html += '</tr>';
      });
      html += '</table>';
      
      content.innerHTML = html;
      modal.style.display = 'block';
    }

    function closeDetailModal() {
      document.getElementById('detailModal').style.display = 'none';
    }

    // Close modal when clicking outside
    document.getElementById('detailModal').addEventListener('click', function(e) {
      if (e.target === this) closeDetailModal();
    });

    function attachStatCardListeners() {
      const statsSection = document.getElementById('statsSection');
      if (!statsSection) return;
      
      const cards = statsSection.querySelectorAll('.stat-card');
      cards.forEach((card, idx) => {
        card.style.cursor = 'pointer';
        card.style.transition = 'all 200ms ease';
        if (idx === 0) {
          card.addEventListener('click', () => openDetailModal('activeJobs'));
          card.title = 'Click to view all Active Jobs';
        } else if (idx === 1) {
          card.addEventListener('click', () => openDetailModal('pendingInspections'));
          card.title = 'Click to view all Pending Inspections';
        } else if (idx === 2) {
          card.addEventListener('click', () => openDetailModal('registeredWarranties'));
          card.title = 'Click to view all Registered Warranties';
        }
        card.addEventListener('mouseenter', () => {
          card.style.transform = 'translateY(-2px)';
          card.style.boxShadow = '0 10px 20px rgba(0,0,0,0.15)';
        });
        card.addEventListener('mouseleave', () => {
          card.style.transform = 'translateY(0)';
          card.style.boxShadow = 'none';
        });
      });
    }

    // ── Document Viewer ─────────────────────────────────────────────
    // Opens the doc modal with documents for a given job ID
    function openJobDocuments(jobId) {
      var job = null;
      for (var i = 0; i < detailData.activeJobs.length; i++) {
        if (detailData.activeJobs[i].id === jobId) {
          job = detailData.activeJobs[i];
          break;
        }
      }
      if (!job) return;

      var docs = job.documents || [];
      var modal = document.getElementById('docModal');
      var titleEl = document.getElementById('docModalTitle');
      var contentEl = document.getElementById('docModalContent');

      titleEl.textContent = 'Documents — ' + job.name + ' (' + job.id + ')';

      // Group documents by type
      var groups = {};
      docs.forEach(function(doc) {
        var key = doc.type || 'Other';
        if (!groups[key]) groups[key] = [];
        groups[key].push(doc);
      });

      var html = '';

      // Job summary header
      html += '<div style="display:flex;gap:16px;align-items:center;padding:12px 16px;background:#f0f7ff;border-radius:8px;margin-bottom:20px;flex-wrap:wrap">';
      html += '<div style="flex:1;min-width:200px">';
      html += '<div style="font-weight:600;color:#1e3a5f;font-size:15px">' + escapeHtml(job.name) + '</div>';
      html += '<div style="color:#586a6b;font-size:13px;margin-top:2px">Job #' + escapeHtml(job.id) + ' &middot; Created ' + escapeHtml(job.date) + '</div>';
      html += '</div>';
      html += '<div>' + getStatusBadge(job.status) + '</div>';
      html += '<div style="color:#586a6b;font-size:13px"><strong>' + docs.length + '</strong> document' + (docs.length !== 1 ? 's' : '') + '</div>';
      html += '</div>';

      if (docs.length === 0) {
        html += '<div style="text-align:center;padding:40px 20px;color:#6b7280">';
        html += '<div style="font-size:48px;margin-bottom:12px;opacity:0.4">&#128196;</div>';
        html += '<p style="font-size:15px;margin:0">No documents uploaded for this job yet.</p>';
        html += '</div>';
      } else {
        // Render each group
        var groupOrder = ['Product Document', 'Warranty Document', 'Inspection Report', 'Photo', 'Other'];
        var groupIcons = {
          'Product Document': '&#128209;',
          'Warranty Document': '&#128203;',
          'Inspection Report': '&#128203;',
          'Photo': '&#128247;',
          'Other': '&#128196;'
        };

        groupOrder.forEach(function(groupName) {
          if (!groups[groupName] || groups[groupName].length === 0) return;

          html += '<div style="margin-bottom:20px">';
          html += '<h3 style="font-size:14px;color:#374151;margin:0 0 10px;display:flex;align-items:center;gap:6px">';
          html += '<span>' + (groupIcons[groupName] || '&#128196;') + '</span> ';
          html += escapeHtml(groupName) + 's';
          html += '<span style="background:#e5e7eb;color:#6b7280;font-size:11px;padding:2px 8px;border-radius:10px;margin-left:4px">' + groups[groupName].length + '</span>';
          html += '</h3>';

          if (groupName === 'Photo') {
            // Photo grid with thumbnails
            html += '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px">';
            groups[groupName].forEach(function(doc) {
              html += '<div class="doc-card" style="border:1px solid #e5e7eb;border-radius:8px;overflow:hidden;transition:box-shadow 200ms,transform 200ms;cursor:pointer" onclick="openImagePreview(\'' + escapeAttr(doc.url) + '\', \'' + escapeAttr(doc.name) + '\')">';
              html += '<div style="width:100%;height:140px;background:#f3f4f6;display:flex;align-items:center;justify-content:center;overflow:hidden">';
              html += '<img src="' + escapeAttr(doc.url) + '" alt="' + escapeAttr(doc.name) + '" style="width:100%;height:100%;object-fit:cover" onerror="this.style.display=\'none\';this.parentElement.innerHTML=\'<span style=padding:20px;color:#9ca3af;font-size:40px>&#128247;</span>\'">';
              html += '</div>';
              html += '<div style="padding:10px">';
              html += '<div style="font-weight:500;font-size:13px;color:#1f2937;white-space:nowrap;overflow:hidden;text-overflow:ellipsis" title="' + escapeAttr(doc.name) + '">' + escapeHtml(doc.name) + '</div>';
              html += '<div style="font-size:11px;color:#6b7280;margin-top:4px">' + escapeHtml(doc.size || '') + (doc.uploadedBy ? ' &middot; ' + escapeHtml(doc.uploadedBy) : '') + '</div>';
              html += '<div style="font-size:11px;color:#9ca3af;margin-top:2px">' + escapeHtml(doc.uploadedAt || '') + '</div>';
              html += '</div>';
              html += '</div>';
            });
            html += '</div>';
          } else {
            // File list for PDFs and other documents
            groups[groupName].forEach(function(doc) {
              html += '<div class="doc-card" style="display:flex;align-items:center;gap:14px;padding:12px 14px;border:1px solid #e5e7eb;border-radius:8px;margin-bottom:8px;transition:box-shadow 200ms,background 200ms;cursor:default">';
              html += '<div style="width:42px;height:42px;border-radius:8px;background:#fef2f2;display:flex;align-items:center;justify-content:center;flex-shrink:0">';
              html += '<span style="font-size:20px;color:#c62828">&#128196;</span>';
              html += '</div>';
              html += '<div style="flex:1;min-width:0">';
              html += '<div style="font-weight:500;font-size:14px;color:#1f2937;white-space:nowrap;overflow:hidden;text-overflow:ellipsis" title="' + escapeAttr(doc.name) + '">' + escapeHtml(doc.name) + '</div>';
              html += '<div style="font-size:12px;color:#6b7280;margin-top:2px">';
              html += escapeHtml(doc.size || 'Unknown size');
              if (doc.uploadedBy) html += ' &middot; Uploaded by ' + escapeHtml(doc.uploadedBy);
              if (doc.uploadedAt) html += ' &middot; ' + escapeHtml(doc.uploadedAt);
              html += '</div>';
              html += '</div>';
              html += '<a href="' + escapeAttr(doc.url) + '" target="_blank" rel="noopener" class="doc-btn" style="text-decoration:none;white-space:nowrap;display:flex;align-items:center;gap:4px" onclick="event.stopPropagation()" title="Download ' + escapeAttr(doc.name) + '">&#8681; Download</a>';
              html += '</div>';
            });
          }
          html += '</div>';
        });
      }

      contentEl.innerHTML = html;
      modal.style.display = 'block';
    }

    // Close the documents modal
    function closeDocModal() {
      document.getElementById('docModal').style.display = 'none';
    }

    // Close doc modal when clicking outside
    document.getElementById('docModal').addEventListener('click', function(e) {
      if (e.target === this) closeDocModal();
    });

    // Close modals on Escape key
    document.addEventListener('keydown', function(e) {
      if (e.key === 'Escape') {
        if (document.getElementById('docModal').style.display === 'block') {
          closeDocModal();
        } else if (document.getElementById('detailModal').style.display === 'block') {
          closeDetailModal();
        }
      }
    });

    // Fullscreen image preview for photos
    function openImagePreview(url, name) {
      var overlay = document.createElement('div');
      overlay.id = 'imagePreviewOverlay';
      overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.85);z-index:1200;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:20px;cursor:zoom-out';
      overlay.onclick = function() { overlay.remove(); };

      var header = document.createElement('div');
      header.style.cssText = 'color:white;font-size:14px;margin-bottom:12px;text-align:center;max-width:90%';
      header.textContent = name;

      var img = document.createElement('img');
      img.src = url;
      img.alt = name;
      img.style.cssText = 'max-width:90%;max-height:80vh;border-radius:8px;box-shadow:0 8px 32px rgba(0,0,0,0.4)';
      img.onclick = function(e) { e.stopPropagation(); };

      var closeBtn = document.createElement('button');
      closeBtn.innerHTML = '&times;';
      closeBtn.style.cssText = 'position:absolute;top:20px;right:28px;background:none;border:none;color:white;font-size:36px;cursor:pointer;opacity:0.8';
      closeBtn.onclick = function() { overlay.remove(); };

      overlay.appendChild(closeBtn);
      overlay.appendChild(header);
      overlay.appendChild(img);
      document.body.appendChild(overlay);
    }

    // Status badge generator (reuse same colors as active jobs table)
    function getStatusBadge(status) {
      var s = (status || '').toString();
      var bg = '#f3f4f6', color = '#374151';
      if (/in progress/i.test(s)) { bg = '#e6f7ff'; color = '#0369a1'; }
      else if (/pending/i.test(s)) { bg = '#fff7ed'; color = '#92400e'; }
      else if (/planning/i.test(s)) { bg = '#f8fafc'; color = '#6b7280'; }
      else if (/not started/i.test(s)) { bg = '#f8fafc'; color = '#6b7280'; }
      else if (/complete|completed|done/i.test(s)) { bg = '#e6ffed'; color = '#047857'; }
      return '<span style="background:' + bg + ';color:' + color + ';padding:4px 10px;border-radius:4px;font-size:13px;font-weight:500">' + escapeHtml(s) + '</span>';
    }

    // HTML escape helper
    function escapeHtml(str) {
      var div = document.createElement('div');
      div.appendChild(document.createTextNode(str));
      return div.innerHTML;
    }
    // Attribute escape helper
    function escapeAttr(str) {
      return (str || '').replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }
  </script>

  <script>
    // After app.js initializes, wire session and set role (original code)
    (function finishInit(){
      const session = sessionStorage.getItem('demoUser');
      if(!session){
        location.href = 'index.html';
        return;
      }
      const user = JSON.parse(session || '{}');

      function normalize(roleLabel){
        return (roleLabel || '').toString().toLowerCase().replace(/\s+/g,'-');
      }

      const roleKey = normalize(user.role) || 'contractor';
      const roleDropdown = document.getElementById('userRole');
      if(roleDropdown){
        if(Array.from(roleDropdown.options).some(o=>o.value===roleKey)){
          roleDropdown.value = roleKey;
        }
      }

      const userInfo = document.getElementById('userInfo');
      if(userInfo) userInfo.textContent = (user.name || user.email || '') + ' • ' + (user.role || '');

      if(typeof updateDashboard === 'function'){
        updateDashboard(roleKey);
      }

      document.getElementById('signOut').addEventListener('click', ()=>{
        sessionStorage.removeItem('demoUser');
        location.href = 'index.html';
      });

      // Make stat cards interactive
      attachStatCardListeners();
    })();
  </script>
</body>
</html>